<script type="text/javascript" src="http://cdn.happy-dev.fr/LDP-framework/ldpframework.js"></script>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.12.0/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
<script src="/library/jquery.polymer-1.0.js"></script>
<script src="/library/jquery-ui.polymer-1.0.js"></script>
<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
<script>
    (function(){
        var localDoc = document._currentScript.ownerDocument;
        var store = new MyStore({context: "http://owl.openinitiative.com/oicontext.jsonld", defaultSerializer: 'application/ld+json'});
        var stateName = ['Proposé','Accepté','Demarré','Livré','Validé'];

        var taskPrototype = Object.create(HTMLElement.prototype, {
			attributeChangedCallback: {

                value: function(attribute) {
                    if(attribute== 'data-target' && this.dataset.target){
                      // console.log(this.querySelector('.target'));
                    };
                    //test if data is available
                    if(attribute== 'data-src' && this.dataset.src){
                        // console.dir(this.dataset.scr);
                        store.get(this.dataset.src).then(task=>{
                            this.dataset.target = task.target? task.target['@id']:"";
                            this.dataset.state = task.state;
                            this.dataset.id = task['@id'];
                            var initialDisplay = (this.parentNode.localName == "oi-tasklist")?'display:inline-block;':'display:block;';
                            // console.log(this.dataset);
                            // console.dir(task);
                            //remove all child elements before add
                            while(this.firstChild) this.removeChild(this.firstChild);
                            if(this.parentNode.localName == "oi-tasklist"){
                                this.appendField('id', task['@id'].match(/\d+/));
                                this.appendField('state', stateName[task.state]);

                            }
                            this.appendField('title', task.title);
                            this.appendField('target', task.target?task.target.name:"");
                            this.appendField('author', task.author?task.author.fullName:"");
                            var form = document.createElement('form')
                            form.setAttribute('style','display:none;');
                            var formNode = this.appendChild(form);
                            formNode.innerHTML = `<textarea name="title" class="titleForm">${$(this).children('.title')[0].innerText}</textarea>
                                        <input type="hidden" name="@id" value="${this.dataset.id}" class="idForm">
                                        <input type="text" name="target" value="${this.dataset.target}" class="targetForm">
                                        <select name="state" class="stateForm">
                                          <option value="0" ${this.dataset.state==0?'selected':''}>Proposé</option>
                                          <option value="1" ${this.dataset.state==1?'selected':''}>Accepté</option>
                                          <option value="2" ${this.dataset.state==2?'selected':''}>Démarré</option>
                                          <option value="3" ${this.dataset.state==3?'selected':''}>Livré</option>
                                          <option value="4" ${this.dataset.state==4?'selected':''}>Validé</option>
                                        </select>
                                        <input type="image" name="submit" src="../../images/ok.svg" border="0" alt="Submit" class="submitForm"/>
                                        <input type="image" src="../../images/cancel.svg" border="0" alt="reset" class="resetForm"/>`;

                            //click to modifie a task
                            $(this).children('span').click(t => {
                                // console.log(t);
                                // console.log(t.target.className);
                                $('oi-task form').hide();
                                $(`oi-task .${t.target.className}Form`).show();
                                // if(t.target.className == 'target'){
                                //   $('oi-task .targetForm').attr('style','display:block;');
                                //   $('oi-task .titleForm').attr('style','display:none;');
                                //   $('oi-task .stateForm').attr('style','display:none;');
                                // }
                                // if(t.target.className == 'title'){
                                //   $('oi-task .targetForm').attr('style','display:none;');
                                //   $('oi-task .titleForm').attr('style','display:block;');
                                //   $('oi-task .stateForm').attr('style','display:none;');
                                // };
                                // if(t.target.className == 'state'){
                                //   $('oi-task .targetForm').attr('style','display:none;');
                                //   $('oi-task .titleForm').attr('style','display:none;');
                                //   $('oi-task .stateForm').attr('style','display:block;');
                                // };
                                // if(t.target.className == 'target'){$(t.target).attr('style','display:none;')};
                                $('oi-task form').attr('style','display:none;');
                                $('oi-task span').attr('style',initialDisplay);
                                this.querySelector('form').setAttribute('style',initialDisplay);
                                $(this).children('span').hide();
                                this.querySelector('.submitForm').addEventListener('click', a=>{
                                    event.preventDefault(); //bloc function submit as HTML
                                    console.log($(formNode).serializeArray());
                                    var project = {"@context" : "http://owl.openinitiative.com/oicontext.jsonld", 'target' : {'@id' : ''}}
                                    JSON.parse(JSON.stringify($(formNode).serializeArray())).forEach(d => {
                                        if(d.name =='target'){
                                            project['target']['@id'] = d.value;
                                        } else {
                                            project[d.name] = d.value;
                                        }
                                        if(d.name =='title'){this.querySelector('.title').innerText = d.value}
                                    });
                                    store.save(project);
                                    this.querySelector('form').setAttribute('style','display:none;');
                                    $(this).children('span').show();
                                });
                                this.querySelector('.resetForm').addEventListener('click', a=>{
                                    event.preventDefault(); //bloc function submit as HTML
                                    this.querySelector('form').setAttribute('style','display:none;');
                                    console.dir(this.querySelector('form'));
                                    $(this).children('span').show();
                                });
                            });

                        });

                    }
                }
            }
		});

        taskPrototype.appendField = function(name, value) {
                var span = document.createElement('span');
                span.className = name;
                span.innerHTML = value;
                this.appendChild(span);
            };

        document.registerElement('oi-task',{prototype: taskPrototype});
    })();
</script>
