<script type="text/javascript" src="http://cdn.happy-dev.fr/LDP-framework/ldpframework.js"></script>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.12.0/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
<script src="/library/jquery.polymer-1.0.js"></script>
<script src="/library/jquery-ui.polymer-1.0.js"></script>
<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
<script>
    (function(){
        var localDoc = document._currentScript.ownerDocument;
        var store = new MyStore({context: "http://owl.openinitiative.com/oicontext.jsonld", defaultSerializer: 'application/ld+json'});

        var taskPrototype = Object.create(HTMLElement.prototype, {
			attributeChangedCallback: {

                value: function(attribute) {
                    //test if data is available
                    if(attribute== 'data-src' && this.dataset.src){
                        // console.dir(this.dataset.scr);
                        store.get(this.dataset.src).then(task=>{
                            this.dataset.target = task.target? task.target['@id']:"";
                            this.dataset.state = task.state;
                            this.dataset.id = task['@id'];

                            // console.dir(task);
                            //remove all child elements before add
                            while(this.firstChild) this.removeChild(this.firstChild);
                            this.appendField('title', task.title);
                            this.appendField('target', task.target?task.target.name:"");
                            this.appendField('author', task.author?task.author.fullName:"");

                            this.addEventListener('contextmenu',function(){
                                event.preventDefault(); //bloc function submit as HTML
                                // this.shadowRoot = his.ownerDocument.querySelector('oi-kanban').shadowRoot;
                                this.parentNode.shadowRoot.querySelector('.idForm').value = task['@id'];
                                this.parentNode.shadowRoot.querySelector('.titleForm').value = task.title;
                                this.parentNode.shadowRoot.querySelector('.stateForm').value = task.state;
                                if(task.author){
                                    this.parentNode.shadowRoot.querySelector('.authorForm').value = task.author['@id'];
                                }
                                this.parentNode.shadowRoot.querySelector('.optionForm').style.display = "block";
                            }.bind(this))
                        });

                    }
                }
            }
		});

        taskPrototype.appendField = function(name, value) {
                var span = document.createElement('span');
                span.className = name;
                span.innerHTML = value;
                this.appendChild(span);
            };

        document.registerElement('oi-task',{prototype: taskPrototype});
    })();
</script>
