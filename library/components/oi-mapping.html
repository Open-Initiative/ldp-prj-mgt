<template id="task-head">
    <style scoped>
        *{
            box-sizing: border-box;
        }
        h1, h3 {
            color: #CCC;
        }
        div {
            border-top: solid 1px #fff;
            padding-left: 0px;
        }
        .liste {
            display:inline-block;
            width:20%;
            padding: 0.5em 5px;
            border: solid 1px #fff;
            background-color: #fc0;
            color: #fff;
            vertical-align: text-top;
        }
        .task {
            background-color: #fff;
            color:#000;
        }
        h4{
            margin : 0 2px;
        }
        .node circle {
            cursor: pointer;
            fill: #fff;
            stroke: steelblue;
            stroke-width: 1.5px;
        }

        .node text {
            font-size: 11px;
        }

        path.link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
        }

    </style>
    <h1>Tableau des tâches du projet</h1>
    <h3 class="stitre"></h3>
</template>
<script type="text/javascript" src="http://happy-dev.fr/library/LDP-framework/ldpframework.js"></script>
<script type="text/javascript" src="../d3.js"></script>
<script type="text/javascript" src="../d3.layout.js"></script>
<script>
    (function(){
        var localDoc = document._currentScript.ownerDocument;
        //paramétrage du garphe
        var m = [20, 120, 20, 120],
            w = 1280 - m[1] - m[3],
            h = 800 - m[0] - m[2],
            i = 0,
            root;

        var tree = d3.layout.tree()
            .size([h, w]);

        var diagonal = d3.svg.diagonal()
            .projection(function(d) { return [d.y, d.x]; });

        var vis = d3.select("#body").append("svg:svg")
            .attr("width", w + m[1] + m[3])
            .attr("height", h + m[0] + m[2])
          .append("svg:g")
            .attr("transform", "translate(" + m[3] + "," + m[0] + ")");
        //fin paramétrage graphe
        window.store = new MyStore({context: "http://owl.openinitiative.com/oicontext.jsonld"});
		var taskListPrototype = Object.create(HTMLElement.prototype, {
			createdCallback: {
                value: function() {
                    var template = localDoc.querySelector('#task-head');
                    var clone = document.importNode(template.content, true);
                    var liste =[];//liste des rubriques
                    var iliste = 0;//index de liste
                    var col = [];//colonnes html exportées dans le shadowDOM
                    var rub;//rubrique en cours

                    // la variable p contient le projet
                    store.get("http://projects.openinitiative.com/project/ldpcontainer/2269").then(x=>{
                        p=x;
                        for(i=0;i<p.descendants.length;i++){
                            // la variable t contient les taches
                            store.get(p.descendants[i]).then(x=>{
                                t=x;
                                //si pas de lot création d'une liste A classer
                                !t.target?rub="A classer":rub=t.target.name;
                                //recherche le lot dans la variable liste
                                if(!liste.find(e => e == rub)){
                                    col[iliste]=document.createElement("div");
                                    col[iliste].className = "liste";
                                    col[iliste].innerHTML = "<h4>"+ rub +"</h4>";
                                    clone.appendChild(col[iliste]);
                                    this.shadowRoot.appendChild(clone);
                                    liste.push(rub);
                                };
                                if(!t.target){
                                    iliste=liste.indexOf("A classer");
                                }else{
                                    iliste=liste.indexOf(t.target.name);
                                }
                                var task = document.createElement("div");
                                task.className = "task";
                                task.innerHTML = "<h4>"+ t.id +"</h4>";
                                task.innerHTML += "<h4>"+ t.title +"</h4>";
                                task.innerHTML += "<p>Etat : "+ t.state +" Auteur : <a href=\""+t.author['@id']+"\" target=\"_blank\">"+ t.author.fullName +"</a></p>";
                                this.shadowRoot.querySelectorAll('.liste')[iliste].appendChild(task);
                            });
                        }
                        //creation du sous titre
                        var stitle = template.content.querySelector('.stitre');
                        stitle.innerHTML = "Project : "+ p.title +", Id : " + p.id;

                        //mise à jour du shadow DOM
                        clone.appendChild(stitle);
                        this.createShadowRoot().appendChild(clone);
                    });

                    //console.dir(this.dataset);
                }
            }
		});


        document.registerElement('oi-kanban',{prototype: taskListPrototype});


    })();

</script>
