<template id="task-head">
    <style scoped>
        *{
            box-sizing: border-box;
        }
        h1, h3 {
            color: #CCC;
        }
        div {
            border-top: solid 1px #fff;
            padding-left: 0px;
            width:100%;
        }
        .id,  .state,  .title,  .author,  .target,  .comment {
            padding: 5px 5px;
            border-right: solid 1px #fff;
        }
        .head{
            background-color: #fc0;
            color: #fff;
        }
        .head input{
            width : 100%;
            background-color: #fd8;
            margin-top:1px;
            border:none;
        }
        .head span{
            display:inline-block;
        }
        oi-task{
            display:inline-table;
            width:100%;
            background-color: #eee;
            color: #000;
            padding: 0;
        }
        oi-task span{
            display:inline-block;
            background-color: #eee;
            margin:0;
            overflow: hidden;
        }
        ::content oi-task{
            display:inline-table;
            width:100%;
            background-color: #eee;
            color: #000;
            padding: 0;
        }
        ::content oi-task span{
            display:inline-block;
            background-color: #eee;
            margin:0;
            overflow: hidden;
        }
        .id, .state, .target {
            width:5%;
        }
        ::content .id, ::content .state, ::content .target {
            width:5%;
        }
        .author, .comment{
            width:15%;
        }
        .title {
            width:55%;
        }
        ::content .title {
            width:55%;
        }
        .titleForm {
            width:100px;
        }
        ::content .titleForm {
            width:400px;
        }
    </style>
    <h1>Tableau des tâches du projet</h1>
    <h3 class="stitre"></h3>
    <div class="head"></div>
    <content></content>

</template>

<script type="text/javascript" src="http://cdn.happy-dev.fr/LDP-framework/ldpframework.js"></script>
<script>
    (function(){
        var localDoc = document._currentScript.ownerDocument;
        var store = new MyStore({context: "http://owl.openinitiative.com/oicontext.jsonld", defaultSerializer: 'application/ld+json'});
		var taskListPrototype = Object.create(HTMLElement.prototype, {
			createdCallback: {
                value: function() {
                    var clone = document.importNode(localDoc.querySelector('#task-head').content, true);
                    this.createShadowRoot().appendChild(clone);

                    store.get(this.dataset.src).then(project=>{
                        console.log(project);
                        project.descendants.forEach(function(task, index){
                            var newTask =  document.createElement('oi-task');
                            newTask.dataset.src=task['@id'];
                            this.appendChild(newTask);
                        }.bind(this));


                        //creation of sub-title

                        this.shadowRoot.querySelector('.stitre').innerHTML = `Project : ${project.title} , Url : ${project['@id']}`;
                        //creation of header of table
                        var content = "";
                        [{n:'Id',s:'id'}, {n:'Etat',s:'state'}, {n:'Titre',s:'title'}, {n:'Lot',s:'target'}, {n:'Auteur',s:'author'}, {n:'Commentaire(s)',s:'comment'}].forEach((col,i) => content +=
                        `<span class=${col.s}>${col.n}<br><input id="${col.s}"></input></span>`);
                        var tableHeader= this.shadowRoot.querySelector('.head');
                        tableHeader.innerHTML = content;
                        //détection relachement touche sur un champ de la barre de titre
                        tableHeader.addEventListener("keyup",function(){
                            // initialise affichage à visible
                            this.querySelectorAll('oi-task').forEach(elt => elt.style.display='inline-table');
                            console.log(tableHeader.querySelector('#id').value);
                            // chxxx contient the string to search in the xxx column
                            var chid = tableHeader.querySelector('#id').value;
                            var chstate =tableHeader.querySelector('#state').value;
                            var chtitle = tableHeader.querySelector('#title').value.toUpperCase();
                            var chauthor = tableHeader.querySelector('#author').value.toUpperCase();
                            var chTarget = tableHeader.querySelector('#target').value.toUpperCase();
                            var chcomment = tableHeader.querySelector('#comment').value.toUpperCase();
                            // basexxx contient all the <span class="xxx">
                            this.querySelectorAll('oi-task .id').forEach(elt =>{if(elt.innerHTML.indexOf(chid)==-1){elt.parentNode.style.display='none';}});
                            this.querySelectorAll('oi-task .state').forEach(elt =>{if(elt.innerHTML.indexOf(chstate)==-1){elt.parentNode.style.display='none';}});
                            this.querySelectorAll('oi-task .title').forEach(elt =>{if(elt.innerHTML.toUpperCase().indexOf(chtitle)==-1){elt.parentNode.style.display='none';}});
                            this.querySelectorAll('oi-task .author').forEach(elt =>{if(elt.innerHTML.toUpperCase().indexOf(chauthor)==-1){elt.parentNode.style.display='none';}});
                            this.querySelectorAll('oi-task .target').forEach(elt =>{if(elt.innerHTML.toUpperCase().indexOf(chTarget)==-1){elt.parentNode.style.display='none';}});
                            this.querySelectorAll('oi-task .comment').forEach(elt =>{if(elt.innerHTML.toUpperCase().indexOf(chcomment)==-1){elt.parentNode.style.display='none';}});
                        }.bind(this));

                    });

                }
            }
		});

        document.registerElement('oi-tasklist',{prototype: taskListPrototype});

    })();

</script>
