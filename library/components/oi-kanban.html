<template id="task-head">
<style>
    *{
        box-sizing: border-box;
    }
    .surface {
        width:100hw;
        height: 90vh;
        overflow-x: scroll;
        overflow-y: auto;
    }
    h1, h3 {
        color: #CCC;
    }
    .board {
        width:2400px;
    }
    .liste {
        display:inline-block;
        width:220px;
        padding: 0 0;
        border: solid 1px #fff;
        background-color: #fc0;
        color: #fff;
        vertical-align: text-top;
        overflow-y: hidden;

    }
    .listeContent {
        max-height: 70vh;
        overflow-y: auto;
    }
    /* ::content is for the compatibility fireFox Chrome */
    ::content oi-task {
        display: block;
        background-color: #fff;
        color:#000;
        list-style-type: none;
        margin: 2px 4px;
        overflow-y: auto;
        width: 97%;
    }
    ::content oi-task span {
        display: block;
        background-color: #fff;
        color:#000;
        list-style-type: none;
    }
    ::content oi-task .title {
        font-weight: bold;
    }
    oi-task {
        display: inline-block;
        background-color: #fff;
        color:#000;
        list-style-type: none;
        margin: 2px 4px;
    }
    oi-task span {
        display: block;
        background-color: #fff;
        color:#000;
        list-style-type: none;
        width: 100%;
    }
    h4{
        margin : 0;
        padding: 3px;
        user-select: none;
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
    ul{
        padding-left: 0px;
        float: left;
    }
    label{
        display:inline-block;
        width:40px;
    }
    .showFormTask:hover {
        cursor: pointer;
    }
    ::content .titleForm {
        width:150px;
        height:60px;
    }
</style>
<div class="pageHeader">
    <h3 class="stitre"></h3>
</div>
<div class="surface">
    <div class="pageContent">
        <div class="board">
            <content select="[data-target='']"></content> <!-- To show before the table the tasks witch not have target -->
            <div id="kanban"></div>
        </div>
    </div>
</div>
</template>
<script type="text/javascript" src="http://cdn.happy-dev.fr/LDP-framework/ldpframework.js"></script>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.12.0/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
<script>
    (function(){
        var localDoc = document._currentScript.ownerDocument;
        var store = new MyStore({context: "http://owl.openinitiative.com/oicontext.jsonld", defaultSerializer: 'application/ld+json'});

        var taskListPrototype = Object.create(HTMLElement.prototype, {
			createdCallback: {

                value: function() {
                    this.setColumns();
                    if(this.dataset.src){this.setContainer(this.dataset.src)};
                }
            },
            attributeChangedCallback: {
                value: function(attrName, oldVal, newVal) {
                    if(attrName == 'data-src'){
                        this.setContainer(newVal);
                    }

                }
            }
		});

        //create the background of kanban
        taskListPrototype.setColumns = function() {
            var clone = document.importNode(localDoc.querySelector('#task-head').content, true);
            var content = '';
            var colElt = [{'name': 'lot 1','filter':'', 'target' : {"@id": "http://pp.projects.openinitiative.com/release/ldpcontainer/45"}},
                        {'name': 'Proposé','filter':'[data-state=\'0\']','target' : {"@id": "http://pp.projects.openinitiative.com/release/ldpcontainer/46"}, 'state':'0'},
                        {'name': 'Accepté','filter':'[data-state=\'1\']','target' : {"@id": "http://pp.projects.openinitiative.com/release/ldpcontainer/46"}, 'state':'1'},
                        {'name': 'Démarré','filter':'[data-state=\'2\']','target' : {"@id": "http://pp.projects.openinitiative.com/release/ldpcontainer/46"}, 'state':'2'},
                        {'name': 'Livré','filter':'[data-state=\'3\']','target' : {"@id": "http://pp.projects.openinitiative.com/release/ldpcontainer/46"}, 'state':'3'},
                        {'name': 'Validé','filter':'[data-state=\'4\']','target' : {"@id": "http://pp.projects.openinitiative.com/release/ldpcontainer/46"}, 'state':'4'},
                        {'name': 'lot 3','filter':'','target' : {"@id": "http://pp.projects.openinitiative.com/release/ldpcontainer/47"}},
                        {'name': 'lot 4','filter':'','target' : {"@id": "http://pp.projects.openinitiative.com/release/ldpcontainer/48"}}];
            colElt.forEach((listObj,i) => {
                content +=
                    `<div class="liste">
                        <h4 class="nameLot">${listObj.name}</h4>
                        <div class="listeContent">
                            <content select="[data-target='${listObj.target['@id']}']${listObj.filter}"></content>
                        </div>
                        <div>
                            <span class="showFormTask" data-form="${i}">Ajouter une tâche</span>
                        </div>
                    </div>`;
                }
            );

            clone.querySelector('#kanban').innerHTML = content;
            this.createShadowRoot().appendChild(clone); //disabled shadow root to get jquery compatibility
            // click to show the form to append a task
            this.shadowRoot.querySelectorAll('.showFormTask').forEach(e=>e.addEventListener('click', c => {
                var formAddTask = document.createElement('form');
                formAddTask.setAttribute('style','height:60px;');
                e.parentNode.appendChild(formAddTask);
                $(e)[0].hidden = true;
                // console.dir($(e)[0]);
                formAddTask.innerHTML = `<textarea type="text" name="title" class="titleForm"></textarea><br>
                            <input type="hidden" name="author" value="http://pp.projects.openinitiative.com/user/ldpcontainer/601">
                            <input type="hidden" name="target" value="${colElt[e.dataset.form].target['@id']}" class="targetForm">
                            <input type="hidden" name="state" value="${colElt[e.dataset.form].state || 0}" class="stateForm">
                            <input type="submit" value="Créer" class="submitForm">
                            <input type="button" value="Fermer" class="resetForm">`;
                e.nextElementSibling.querySelector('.submitForm').addEventListener('click', a=>{
                    event.preventDefault(); //bloc function submit as HTML
                    var newProject = {"@context" : "http://owl.openinitiative.com/oicontext.jsonld" , 'target' : {'@id' : ''}}
                    JSON.parse(JSON.stringify($(e.nextElementSibling).serializeArray())).forEach(d => {
                        if(d.name =='target'){
                            newProject['target']['@id'] = d.value;
                        } else {
                            newProject[d.name] = d.value;
                        }
                    });
                    // console.log(newProject);
                    store.save(newProject).then(project=>{
                        // console.log(project['@graph'][0]['@id']);
                        var newTask =  document.createElement('oi-task');
                        newTask.dataset.src="http://pp.projects.openinitiative.com/project/ldpcontainer/" + project['@graph'][0]['@id'];
                        this.appendChild(newTask);

                    })
                    e.nextElementSibling.querySelector('.titleForm').value = '';
                });
                //click to cancel appending task
                e.nextElementSibling.querySelector('.resetForm').addEventListener('click', a=>{
                    e.parentNode.removeChild(e.nextElementSibling);
                    $(e)[0].hidden = false;
                });

            }));

            //writting data when the task change of column
            $(this).sortable({stop: function(event, ui){
                var columnPositions = Array.prototype.map.call(this.shadowRoot.querySelectorAll(".liste"), list => list.offsetLeft);
                var colId = columnPositions.filter(x=>event.clientX>x).length - 1;
                $(event.toElement).closest('oi-task')[0].dataset.target = colElt[colId].target['@id'];
                $(event.toElement).closest('oi-task')[0].dataset.state = colElt[colId].state;
                store.get(event.toElement.parentNode.dataset.src).then(task => store.save(Object.assign(task, colElt[colId])));
            }});

        };

        //modifie the content of the kanban
        taskListPrototype.setContainer = function(uri) {
            // console.log(this.attributes['data-scr'].value);
            // console.log(this.dataset.src);
            store.container = uri;
            store.get(uri).then(project=>{
                //creation of sub-title
                this.shadowRoot.querySelector('.stitre').innerHTML = `Project : ${project.title} , Url : ${project['@id']}`;
                project.descendants.forEach(function(task, index){
                    var newTask =  document.createElement('oi-task');
                    newTask.dataset.src=task['@id'];
                    this.appendChild(newTask);
                }.bind(this));

            });
        };
        document.registerElement('oi-kanban',{prototype: taskListPrototype});
    })();
</script>
