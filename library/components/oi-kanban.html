<template id="task-head">
<style>
    *{
        box-sizing: border-box;
    }
    h1, h3 {
        color: #CCC;
    }
    div {
        border-top: solid 1px #fff;
        padding-left: 0px;
    }
    .liste {
        display:inline-block;
        width:12%;
        padding: 0.5em 5px;
        border: solid 1px #fff;
        background-color: #fc0;
        color: #fff;
        vertical-align: text-top;
    }
    ::content oi-task {
        display: inline-block;
        background-color: #fff;
        color:#000;
        list-style-type: none;
        margin-top: 3px;
    }
    ::content oi-task span {
        display: inline-block;
        background-color: #fff;
        color:#000;
        list-style-type: none;
        width: 100%;
    }
    ::content oi-task .title {
        font-weight: bold;
    }
    oi-task {
        display: inline-block;
        background-color: #fff;
        color:#000;
        list-style-type: none;
        margin-top: 3px;
    }
    oi-task span {
        display: inline-block;
        background-color: #fff;
        color:#000;
        list-style-type: none;
        width: 100%;
    }
    h4{
        margin : 0 2px;
        user-select: none;
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
    ul{
        padding-left: 0px;
        float: left;
    }

</style>
    <h1>Tableau des tâches du projet</h1>
    <h3 class="stitre"></h3>
    <select name="target" class="targetFilter">
        <option value="all">Tous</option>
        <option value="lot 1">Lot 1</option>
        <option value="lot 2">Lot 2</option>
        <option value="lot 3">Lot 3</option>
        <option value="lot 4">Lot 4</option>
    </select>
    <form class="form">
        <input type="text" name="title" value="" placeholder="titre" class="titleForm">
        <input type="text" name="state" value="" placeholder="Etat (0 à 4)" class="stateForm">
        <input type="text" name="target" value="" placeholder="lot" class="targetForm">
        <input type="submit" value="Valider" class="submitForm">
    </form>
    <div id="kanban"></div>
</template>
<script type="text/javascript" src="http://cdn.happy-dev.fr/LDP-framework/ldpframework.js"></script>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.12.0/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
<script>
    (function(){
        var localDoc = document._currentScript.ownerDocument;
        var store = new MyStore({context: "http://owl.openinitiative.com/oicontext.jsonld", defaultSerializer: 'application/ld+json'});

        var taskListPrototype = Object.create(HTMLElement.prototype, {
			createdCallback: {

                value: function() {
                    this.setColumns();
                    if(this.dataset.src){this.setContainer(this.dataset.src)};
                }
            },
            attributeChangedCallback: {
                value: function(attrName, oldVal, newVal) {
                    if(attrName == 'data-src'){
                        this.setContainer(newVal);
                    }

                }
            }
		});

        //create the background of kanban
        taskListPrototype.setColumns = function() {
            var clone = document.importNode(localDoc.querySelector('#task-head').content, true);

            var content = "";
            var colElt = [{'name': 'lot 1', 'target' : {"@id": "http://pp.projects.openinitiative.com/release/ldpcontainer/45"}},
                        {'name': 'Proposé','target' : {"@id": "http://pp.projects.openinitiative.com/release/ldpcontainer/46"}, 'state':'0'},
                        {'name': 'Accepté','target' : {"@id": "http://pp.projects.openinitiative.com/release/ldpcontainer/46"}, 'state':'1'},
                        {'name': 'Démarré','target' : {"@id": "http://pp.projects.openinitiative.com/release/ldpcontainer/46"}, 'state':'2'},
                        {'name': 'Livré','target' : {"@id": "http://pp.projects.openinitiative.com/release/ldpcontainer/46"}, 'state':'3'},
                        {'name': 'Validé','target' : {"@id": "http://pp.projects.openinitiative.com/release/ldpcontainer/46"}, 'state':'4'},
                        {'name': 'lot 3','target' : {"@id": "http://pp.projects.openinitiative.com/release/ldpcontainer/47"}},
                        {'name': 'lot 4','target' : {"@id": "http://pp.projects.openinitiative.com/release/ldpcontainer/48"}}];
            colElt.forEach((listObj,i) => content +=
            `<div class="liste">
                <h4 class="nameLot">${listObj.name}</h4>
                <div>
                    <content select="[data-target='${listObj.target['@id']}'][data-state='${listObj.state}']"></content>
                </div>
            </div>`);
            clone.querySelector('#kanban').innerHTML = content;
            this.createShadowRoot().appendChild(clone); //disabled shadow root to get jquery compatibility

            //writting data when the task change of column
            $(this).sortable({stop: function(event, ui){
                var columnPositions = Array.prototype.map.call(this.shadowRoot.querySelectorAll(".liste"), list => list.offsetLeft);
                var colId = columnPositions.filter(x=>event.clientX>x).length - 1;
                $(event.toElement).closest('oi-task')[0].dataset.target = colElt[colId].target['@id'];
                $(event.toElement).closest('oi-task')[0].dataset.state = colElt[colId].state;
                store.get(event.toElement.parentNode.dataset.src).then(task => store.save(Object.assign(task, colElt[colId])));
            }});


            this.shadowRoot.querySelector('.form').addEventListener("submit",function(event){
                event.preventDefault(); //bloc function submit as HTML
                var project = {"author": {"@id": "http://pp.projects.openinitiative.com/user/ldpcontainer/601"},
                    "@context": "http://owl.openinitiative.com/oicontext.jsonld",
                    "title" : this.shadowRoot.querySelector('.titleForm').value,
                    "state" : this.shadowRoot.querySelector('.stateForm').value,
                    "target" : {"name" : this.shadowRoot.querySelector('.targetForm').value}
                };
                store.save(project);
            }.bind(this));
        };

        //modifie the content of the kanban
        taskListPrototype.setContainer = function(uri) {
            // console.log(this.attributes['data-scr'].value);
            console.log(this.dataset.src);
            store.container = uri;
            store.get(uri).then(project=>{
                //creation of sub-title
                this.shadowRoot.querySelector('.stitre').innerHTML = `Project : ${project.title} , Id : ${project.id}`;
                //                        console.log(project);
                project.descendants.forEach(function(task, index){
                    var newTask =  document.createElement('oi-task');
                    console.dir(newTask);
                    // console.log(task['@id']);
                    newTask.dataset.src=task['@id'];
                    this.appendChild(newTask);
                }.bind(this));
            });

            //controle change of lot filter
            this.shadowRoot.querySelector('.form').addEventListener("mouseup",function(){
                console.log(this);
                this.querySelectorAll('oi-task').forEach(function(elt,i){
                    console.log(elt);
                    elt.style.display='inline-table';
                });
            }.bind(this));
        };
        document.registerElement('oi-kanban',{prototype: taskListPrototype});
    })();
</script>
