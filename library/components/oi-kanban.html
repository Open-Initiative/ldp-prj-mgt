<template id="task-head">
<style scoped>
    *{
        box-sizing: border-box;
    }
    .surface {
        width:100hw;
        height: 90vh;
        overflow-x: scroll;
        overflow-y: auto;
    }
    h1, h3 , a , .option{
        color: #CCC;
    }
    .board {
        width:2400px;
    }
    .liste {
        display:inline-block;
        width:250px;
        padding: 0 0;
        border: solid 1px #fff;
        background-color: #fc0;
        color: #fff;
        vertical-align: text-top;
        overflow-y: hidden;

    }
    .listeContent {
        max-height: 70vh;
        overflow-y: auto;
    }
    /* ::content is for the compatibility fireFox Chrome */
    ::content .liste {
        display:inline-block;
        width:250px;
        padding: 0 0;
        border: solid 1px #fff;
        background-color: #fc0;
        color: #fff;
        vertical-align: text-top;
        overflow-y: hidden;

    }
    ::content .listeContent {
        max-height: 70vh;
        overflow-y: auto;
    }
    ::content oi-task {
        display: block;
        background-color: #fff;
        color:#000;
        list-style-type: none;
        margin: 2px 4px;
        overflow-y: auto;
        width: 97%;
    }
    ::content oi-task span {
        display: block;
        background-color: #fff;
        color:#000;
        list-style-type: none;
    }
    ::content oi-task .title {
        font-weight: bold;
    }
    oi-task {
        display: block;
        background-color: #fff;
        color:#000;
        list-style-type: none;
        margin: 2px 4px;
        overflow-y: auto;
        width: 97%;
    }
    oi-task span {
        display: block;
        background-color: #fff;
        color:#000;
        list-style-type: none;
    }
    oi-task .title {
        font-weight: bold;
    }
    h4{
        margin : 0;
        padding: 3px;
        user-select: none;
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
    ul{
        padding-left: 0px;
        float: left;
    }
    ::content .show_form_task:hover {
        cursor: pointer;
    }
    .show_form_task:hover {
        cursor: pointer;
    }
    ::content .title_form {
        width:220px;
        height:60px;
        font-size: 0.8em;
    }
    .title_form {
        width:220px;
        height:60px;
        font-size: 0.8em;
    }
    ::content .title, ::content .target{
      font-size: 0.8em;
    }
    .title, .target, .show_form_task{
      font-size: 0.8em;
    }
    ::content button {
        border: none;
        background: none;
    }
    button {
        border: none;
        background: none;
    }
    .row_right, .show-option {
        float: right;
    }
    ::content .row_right,::content .show-option {
        float: right;
    }
    .option{
        visibility: hidden;
    }
</style>
<div class="pageHeader">
    <h3 class="stitre"></h3>
    <img src="../../images/row-r.svg" alt="row right" class="row_right">
    <img src="../../images/option.svg" alt="option" class="show-option">
    <div class="option">
        <label><input type="checkbox" id="version-before" value="before" checked class="option-checkbox"> Versions précédentes</label>
        <label><input type="checkbox" id="version-current" value="current" checked class="option-checkbox"> Version courrante</label>
        <label><input type="checkbox" id="version-future" value="future" checked class="option-checkbox"> Versions future</label>
    </div>
</div>
<a href="./index.html">Accès à la liste de tâches</a><br>
<div class="surface">
    <div class="pageContent">
        <div class="board">
            <div id="kanban"></div>
        </div>
    </div>
</div>
<content></content>
</template>
<template id='template-column'>
    <div class="liste">
        <h4 class="nameTarget"></h4>
        <div class="listeContent">
            <content></content>
        </div>
    </div>
</template>
<template id='enable-add'>
    <span class="show_form_task" data-form="${i}">Ajouter une tâche</span>
    <form class="form-add-task" style="display:none;">
        <textarea type="text" name="title" class="title_form"></textarea><br>
        <button type="submit"><img src="../../images/ok.svg" alt="submit"></button>
        <button type="reset"><img src="../../images/cancel.svg" alt="cancel"></button>

    </form>
</template>
<script type="text/javascript" src="http://cdn.happy-dev.fr/LDP-framework/ldpframework.js"></script>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.12.0/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
<script>
    (function(){
        var localDoc = document._currentScript.ownerDocument;
        window.store = new MyStore({context: "http://owl.openinitiative.com/oicontext.jsonld", defaultSerializer: 'application/ld+json'});

        var taskListPrototype = Object.create(HTMLElement.prototype, {
    		createdCallback: {
              value: function() {
                  if(this.dataset.src)this.setContainer(this.dataset.src);
              }
          },
          attributeChangedCallback: {
              value: function(attrName, oldVal, newVal) {
                  if(attrName == 'data-src'){
                      if(newVal) this.setContainer(newVal);
                  }
              }
          }
    	});

        //create the background of kanban
        taskListPrototype.setColumns = function(release_set, target) {
            var clone = document.importNode(localDoc.querySelector('#task-head').content, true);
            var statelist = ['Proposé','Accepté','Demarré','Livré','Validé'];
            var columns = [], past=[], current=[], future=[];
            release_set.forEach((release, i) => {
                if(release['@id']==target['@id']) //current release
                    statelist.map((state, i)=>current.push({'name': state, 'target' : {"@id": release['@id']},'state': i.toString(), 'writeable' : true}));
                else
                    if(release.done)
                        past.push({'name': release.name, 'target' : {"@id": release['@id']}, 'writeable' : false});
                    else
                        future.push({'name': release.name, 'target' : {"@id": release['@id']}, 'writeable' : true});
            });
            columns = past.concat(current, future);
            columns.forEach((column, i) => {
                var columnElt = document.importNode(localDoc.querySelector('#template-column').content, true);
                columnElt.querySelector('.nameTarget').innerText = column.name;
                var filter = (column.target['@id']==target['@id'])?`[data-state=\'${column.state}\']`:``;
                columnElt.querySelector('content').setAttribute('select',`[data-target=\'${column.target['@id']}\']${filter}`);
                if(column.writeable){
                    columnElt.lastElementChild.appendChild(document.importNode(localDoc.querySelector('#enable-add').content, true));
                    columnElt.querySelector('.show_form_task').addEventListener('click', (event) => {
                        event.target.parentElement.querySelector('.form-add-task').setAttribute('style','display:block;')
                    });
                    columnElt.querySelector('.form-add-task').addEventListener('submit', (event) => {
                        event.preventDefault(); //bloc function submit as HTML
                        var newTask = {'title':event.target.querySelector('.title_form').value,'state':column.state||'0','target':column.target};
                        store.save(newTask).then(project=>{
                            var taskElt =  document.createElement('oi-task');
                            //TODO  fix problem or url absolut/relative
                            taskElt.setAttribute("data-src","http://pp.projects.openinitiative.com/project/ldpcontainer/" + project['@graph'][0]['@id']);
                            this.appendChild(taskElt);
                        });
                        event.target.querySelector('.title_form').value = '';
                    });
                    columnElt.querySelector('.form-add-task').addEventListener('reset', (event) => {
                        event.target.setAttribute('style','display:none;')
                    });
                }
                clone.querySelector('#kanban').appendChild(columnElt);
            });
            this.createShadowRoot().appendChild(clone); //disabled shadow root to get jquery compatibility
            //writting data when the task change of column
            $(this).sortable({stop: function(event, ui){
              var columnPositions = Array.prototype.map.call(this.shadowRoot.querySelectorAll(".liste"), list => list.offsetLeft);
              var colId = columnPositions.filter(x=>(event.clientX+this.shadowRoot.querySelector('.surface').scrollLeft)>x).length - 1;
              if(columns[colId].writeable){
                $(event.toElement).closest('oi-task')[0].dataset.target = columns[colId].target['@id'];
                $(event.toElement).closest('oi-task')[0].dataset.state = columns[colId].state;
                store.get(event.toElement.parentNode.dataset.src).then(task => {
                  store.save(Object.assign(task, columns[colId]))
                });
              } else {
                alert('Cette release est close.');
              };
            }});
            //detection of scroll to hide the row when we are at right
            this.shadowRoot.querySelector('.surface').onscroll = function(event){
                if((this.querySelector('#kanban').clientWidth - window.innerWidth - event.target.scrollLeft) < 300){
                    this.parentNode.querySelector('.row_right').style.visibility = 'hidden';
                }else{
                    this.parentNode.querySelector('.row_right').style.visibility = 'visible';
                }
            }
            //Button to show/hide options
            this.shadowRoot.querySelector('.show-option').onclick = function(event){
                this.parentNode.querySelector('.option').style.visibility = (this.parentNode.querySelector('.option').style.visibility == 'visible')?'hidden':'visible';
            }
            var columnKanban = this.shadowRoot.querySelectorAll('.liste');
            this.shadowRoot.querySelector('.option').onchange = function(event){
                columns.forEach((column, i) => {
                    columnKanban[i].style.display = 'inline-block';
                    if(!column.writeable&&!this.querySelector('#version-before').checked) columnKanban[i].style.display = 'none';//tagrget before
                    if(column.state&&!this.querySelector('#version-current').checked) columnKanban[i].style.display = 'none';//tagrget current
                    if(column.writeable&&!column.state&&!this.querySelector('#version-future').checked) columnKanban[i].style.display = 'none';//tagrget future
                });
            }

        };

        //modifie the content of the kanban
        taskListPrototype.setContainer = function(uri) {
            store.container = uri;
            store.get(uri).then(project=>{
                //creation of sub-title
                this.setColumns(project.release_set, project.target);
                this.shadowRoot.querySelector('.stitre').innerHTML = `Project : ${project.title} , Url : ${project['@id']}`;
                project.descendants.forEach(function(task, index){
                    var taskElt =  document.createElement('oi-task');
                    taskElt.setAttribute("data-src",task['@id']);
                    this.appendChild(taskElt);
                }.bind(this));
            });
        };
        document.registerElement('oi-kanban',{prototype: taskListPrototype});
    })();
</script>
