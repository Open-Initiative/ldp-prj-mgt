
<template id="task-head">
<style scoped>
    *{
        box-sizing: border-box;
    }
    .surface {
        width:100hw;
        height: 90vh;
        overflow-x: scroll;
        overflow-y: auto;
    }
    h1, h3 , a , .option{
        color: #CCC;
        margin-bottom: 0;
    }
    .board {
        width:2400px;
    }
    .liste {
        display:inline-block;
        width:250px;
        padding: 0 0;
        border: solid 1px #fff;
        background-color: #fc0;
        color: #fff;
        vertical-align: text-top;
        overflow-y: hidden;

    }
    .listeContent {
        max-height: 70vh;
        overflow-y: auto;
    }
    /* ::content is for the compatibility fireFox Chrome */
    ::content .liste {
        display:inline-block;
        width:250px;
        padding: 0 0;
        border: solid 1px #fff;
        background-color: #fc0;
        color: #fff;
        vertical-align: text-top;
        overflow-y: hidden;

    }
    ::content .listeContent {
        max-height: 70vh;
        overflow-y: auto;
    }
    ::content oi-task {
        display: block;
        background-color: #fff;
        color:#000;
        list-style-type: none;
        margin: 2px 4px;
        overflow-y: auto;
        width: 97%;
    }
    ::content oi-task span {
        display: block;
        background-color: #fff;
        color:#000;
        list-style-type: none;
    }
    ::content oi-task .title {
        font-weight: bold;
    }
    oi-task {
        display: block;
        background-color: #fff;
        color:#000;
        list-style-type: none;
        margin: 2px 4px;
        overflow-y: auto;
        width: 97%;
    }
    oi-task span {
        display: block;
        background-color: #fff;
        color:#000;
        list-style-type: none;
    }
    oi-task .title {
        font-weight: bold;
    }
    h4{
        margin : 0;
        padding: 3px;
        user-select: none;
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
    ul{
        padding-left: 0px;
        float: left;
    }
    ::content .show_form_task:hover {
        cursor: pointer;
    }
    .show_form_task:hover {
        cursor: pointer;
    }
    ::content .title_form {
        width:220px;
        height:60px;
        font-size: 0.8em;
    }
    .title_form {
        width:220px;
        height:60px;
        font-size: 0.8em;
    }
    ::content .title, ::content .target{
      font-size: 0.8em;
    }
    .title, .target, .show_form_task{
      font-size: 0.8em;
    }
    ::content button {
        border: none;
        background: none;
    }
    button {
        border: none;
        background: none;
    }
    .row_right, .show-option {
        float: right;
    }
    ::content .row_right,::content .show-option {
        float: right;
    }
    .option{
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease;
    }
    .show-versions:checked ~ .option{
        max-height: 80px;
    }
    .show-versions{
        opacity: 0;
    }
    .categories{
        background-color: #fc0;
        border : none;
        width: 250px;
        color: white;
    }
    ::content .hidden{
        display: none;
    }
    .hidden{
        display: none;
    }
</style>
<div class="pageHeader">
    <h3 class="stitre"></h3>
    <a href="./index.html">Accès à la liste de tâches</a><br>
    <img src="../../images/row-r.svg" alt="row right" class="row_right">
    <label>
        <input type="checkbox" class="show-versions">
        <img src="../../images/option.svg" alt="option" class="show-option">
        <div class="option">
            <label><input type="checkbox" id="version-before" value="before" checked class="option-checkbox"> Versions précédentes</label>
            <label><input type="checkbox" id="version-current" value="current" checked class="option-checkbox"> Version courante</label>
            <label><input type="checkbox" id="version-future" value="future" checked class="option-checkbox"> Versions future</label>
        </div>
    </label>
</div>
<div class="surface">
    <div class="pageContent">
        <div class="board">
            <div id="kanban"></div>
        </div>
    </div>
</div>
<content></content>
</template>
<template id='template-column'>
    <div class="liste">
        <h4 class="nameTarget"></h4>
        <div class="listeContent">
            <content></content>
        </div>
    </div>
</template>
<template id='enable-add'>
    <span class="show_form_task" data-form="${i}">Ajouter une tâche</span>
    <form class="form-add-task" style="display:none;">
        <textarea type="text" name="title" class="title_form"></textarea><br>
        <button type="submit"><img src="../../images/ok.svg" alt="submit"></button>
        <button type="reset"><img src="../../images/cancel.svg" alt="cancel"></button>

    </form>
</template>
<script type="text/javascript" src="http://cdn.happy-dev.fr/LDP-framework/ldpframework.js"></script>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.12.0/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
<script>
    (function(){
        var localDoc = document._currentScript.ownerDocument;
        window.store = new MyStore({context: "http://owl.openinitiative.com/oicontext.jsonld", defaultSerializer: 'application/ld+json'});

        var taskListPrototype = Object.create(HTMLElement.prototype, {
    		createdCallback: {
              value: function() {
                  if(this.dataset.src)this.setContainer(this.dataset.src);
              }
          },
          attributeChangedCallback: {
              value: function(attrName, oldVal, newVal) {
                  if(attrName == 'data-src'){
                      if(newVal) this.setContainer(newVal);
                  }
              }
          }
    	});

        taskListPrototype.buildColumns = function(release_set, target){
            var past=[], current=[], future=[];
            var statelist = ['Proposé','Accepté','Demarré','Livré','Validé'];
            release_set.forEach((release, i) => {
                if(release['@id']==target['@id']) //current release
                    statelist.map((state, i)=>current.push({'name': state, 'target' : {"@id": release['@id']},'state': i.toString(), 'writeable' : true}));
                else
                    if(release.done)
                        past.push({'name': release.name, 'target' : {"@id": release['@id']}, 'writeable' : false});
                    else
                        future.push({'name': release.name, 'target' : {"@id": release['@id']}, 'writeable' : true});
            });
            return past.concat(current, future);
        }

        taskListPrototype.updateTask = function(event){
          var columnPositions = Array.prototype.map.call(this.shadowRoot.querySelectorAll(".liste"), list => list.offsetLeft);
          var colId = columnPositions.filter(x=>(event.clientX+this.shadowRoot.querySelector('.surface').scrollLeft)>x).length - 1;
          if(this.columns[colId].writeable){
              var taskElt = $(event.toElement).closest('oi-task')[0];
              taskElt.dataset.target = this.columns[colId].target['@id'];
              taskElt.dataset.state = this.columns[colId].state;
              store.get(event.toElement.parentNode.dataset.src).then(task => {
                  store.save(Object.assign(task, this.columns[colId]))
              });
          } else {
              alert('Cette release est close.');
          };
        }

        taskListPrototype.addTask = function(event, column){
            event.preventDefault(); //bloc function submit as HTML
            console.dir(column);
            var newTask = {'title':event.target.querySelector('.title_form').value,'state':column.state||'0','target':column.target};
            var container = this.shadowRoot.querySelector('.categories').value || this.dataset.src;
            store.save(newTask, container).then(project=>{
                var taskElt =  document.createElement('oi-task');
                console.dir(project);
                taskElt.dataset.parent = container;
                //TODO  fix problem or url absolut/relative
                taskElt.setAttribute("data-src","http://pp.projects.openinitiative.com/project/ldpcontainer/" + project['@graph'][0]['@id']);
                this.appendChild(taskElt);
            });
            event.target.querySelector('.title_form').value = '';

        }

        //create the background of kanban
        taskListPrototype.setColumns = function(release_set, target) {
            var clone = document.importNode(localDoc.querySelector('#task-head').content, true);
            this.columns = this.buildColumns(release_set, target);
            this.columns.forEach((column, i) => {
                var columnElt = document.importNode(localDoc.querySelector('#template-column').content, true);
                columnElt.querySelector('.nameTarget').innerText = column.name;
                var filter = (column.target['@id']==target['@id'])?`[data-state=\'${column.state}\']`:``;
                columnElt.querySelector('content').setAttribute('select',`[data-target=\'${column.target['@id']}\']${filter}`);
                if(column.writeable){
                    columnElt.lastElementChild.appendChild(document.importNode(localDoc.querySelector('#enable-add').content, true));
                    columnElt.querySelector('.show_form_task').addEventListener('click', (event) => {
                        event.target.parentElement.querySelector('.form-add-task').setAttribute('style','display:block;');
                    });
                    columnElt.querySelector('.form-add-task').addEventListener('submit', (event) => this.addTask(event, column));
                    columnElt.querySelector('.form-add-task').addEventListener('reset', (event) =>
                        event.target.setAttribute('style','display:none;'));
                }
                clone.querySelector('#kanban').appendChild(columnElt);
            });
            this.createShadowRoot().appendChild(clone); //disabled shadow root to get jquery compatibility
            //writting data when the task change of column
            $(this).sortable({stop: this.updateTask.bind(this) });
            //detection of scroll to hide the row when we are at right
            this.shadowRoot.querySelector('.surface').onscroll = function(event){
                this.parentNode.querySelector('.row_right').classList.toggle('hidden',(this.querySelector('#kanban').clientWidth - window.innerWidth - event.target.scrollLeft) < 300);
            }
            var columnKanban = this.shadowRoot.querySelectorAll('.liste');
            this.shadowRoot.querySelector('#version-before').addEventListener('change', event => {
                this.columns.forEach((column, i) => {
                    columnKanban[i].style.display = 'inline-block';
                    if(!column.writeable&&!this.shadowRoot.querySelector('#version-before').checked) columnKanban[i].style.display = 'none';//tagrget before
                });
            });
            this.shadowRoot.querySelector('#version-current').addEventListener('change', event => {
                this.columns.forEach((column, i) => {
                    columnKanban[i].style.display = 'inline-block';
                    if(column.state&&!this.shadowRoot.querySelector('#version-current').checked) columnKanban[i].style.display = 'none';//tagrget current
                });
            });
            this.shadowRoot.querySelector('#version-future').addEventListener('change', event => {
                this.columns.forEach((column, i) => {
                    columnKanban[i].style.display = 'inline-block';
                    if(column.writeable&&!column.state&&!this.shadowRoot.querySelector('#version-future').checked) columnKanban[i].style.display = 'none';//tagrget future
                });
            });

        };

        //modifie the content of the kanban
        taskListPrototype.setContainer = function(uri) {
            store.container = uri;
            store.get(uri).then(project=>{
                //creation of sub-title
                this.setColumns(project.release_set, project.target);
                this.shadowRoot.querySelector('.stitre').innerHTML = `Project : ${project.title} , Url : ${project['@id']}`;
                //detection of sub-tasks
                if (project['ldp:contains'].length < project['descendants'].length){
                    var categorySelect = document.createElement("select");
                    categorySelect.className = 'categories';
                    this.shadowRoot.querySelector('.pageHeader').appendChild(categorySelect);
                    categorySelect.appendChild(this.AppendSelectInput('Toutes les catégories',''));
                    project['ldp:contains'].forEach(function(category){
                        categorySelect.appendChild(this.AppendSelectInput(category.title, category['@id']));
                        store.get(category).then(category=>{
                            if (category.descendants)
                                category.descendants.forEach(task => this.AppendOiTask(task['@id'], category['@id']));
                        });
                    }.bind(this));
                    categorySelect.addEventListener("change", function(){
                        var tasks = Array.prototype.forEach.call(this.querySelectorAll('oi-task'), function(taskElt){
                            taskElt.classList.toggle('hidden',categorySelect.value != '' && taskElt.dataset.parent != categorySelect.value);
                        });
                    }.bind(this));
                } else {
                    project.descendants.forEach(task => this.AppendOiTask(task['@id'], project['@id']));
                }
            });
        };

        taskListPrototype.AppendSelectInput = function(title, uri){
          var rubric = document.createElement("option");
          rubric.setAttribute('value',uri);
          rubric.innerText = title;
          return rubric;
        }

        taskListPrototype.AppendOiTask = function(uri, parent){
            var taskElt =  document.createElement('oi-task');
            taskElt.setAttribute("data-src",uri);
            taskElt.setAttribute("data-parent",parent);
            this.appendChild(taskElt);
        }
        
        document.registerElement('oi-kanban',{prototype: taskListPrototype});
    })();
</script>
